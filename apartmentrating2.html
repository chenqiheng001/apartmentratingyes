# Create an optimized v3 with IME-safe inputs and incremental updates (no full rerender on each keystroke)
html = r"""<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>看房评分表 · Apartment Scoring Sheet (v3 • Fast)</title>
<style>
  :root{
    --bg:#f6f7fb; --card:#fff; --ink:#0f172a; --muted:#64748b; --line:#e2e8f0; --accent:#0ea5e9;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  h1{font-size:22px;margin:0 0 8px}
  .container{max-width:1200px;margin:0 auto;padding:16px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-bottom:12px}
  .btn{appearance:none;border:1px solid var(--line);background:#fff;color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer}
  .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  .btn.danger{background:#ef4444;color:#fff;border-color:#ef4444}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:0 1px 2px rgb(0 0 0 / 0.04);margin-bottom:14px}
  .card-h{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--line)}
  .card-h h2{font-size:16px;margin:0}
  .badge{background:#111827;color:#fff;border-radius:999px;padding:6px 10px;font-weight:600}
  .card-c{padding:12px 14px}
  .grid{display:grid;gap:12px}
  .g-3{grid-template-columns:repeat(3,minmax(0,1fr))}
  .g-4{grid-template-columns:repeat(4,minmax(0,1fr))}
  .g-5{grid-template-columns:repeat(5,minmax(0,1fr))}
  .g-6{grid-template-columns:repeat(6,minmax(0,1fr))}
  @media (max-width: 980px){ .g-3,.g-4,.g-5,.g-6{grid-template-columns:1fr} }
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  input[type="text"],input[type="number"],select,textarea{
    width:100%;padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:#fff;color:var(--ink)
  }
  textarea{min-height:90px;font-size:15px;line-height:1.6}
  .switch{display:flex;align-items:center;gap:8px}
  .subscores{display:grid;gap:8px;grid-template-columns:repeat(6,minmax(0,1fr))}
  @media (max-width: 980px){ .subscores{grid-template-columns:repeat(2,minmax(0,1fr))} }
  .pill{display:flex;align-items:center;justify-content:space-between;border:1px solid var(--line);border-radius:12px;background:#fff;padding:8px 10px}
  .muted{color:var(--muted)}
  .hint{font-size:12px;color:var(--muted);margin-top:4px}
  .weights-row{display:grid;gap:10px;grid-template-columns:repeat(3,minmax(0,1fr))}
  .weights-item{border:1px solid var(--line);border-radius:12px;background:#fff;padding:10px}
  .weights-item output{font-size:12px;color:var(--muted);margin-left:6px}
  .hr{height:1px;background:var(--line);margin:10px 0}
  .row-topline{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .row-topline .pill{padding:6px 10px}
</style>
</head>
<body>
  <div class="container">
    <div class="toolbar">
      <div>
        <h1>看房评分表 · Apartment Scoring Sheet</h1>
        <div class="muted">v3：优化输入不卡顿（不整卡刷新 DOM）、中文输入不乱字符、只更新计算区域</div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn" id="downloadCsvBtn">导出 CSV</button>
        <button class="btn primary" id="addRowBtn">添加一套房源</button>
      </div>
    </div>

    <!-- 权重设置 -->
    <div class="card">
      <div class="card-h"><h2>权重调整（总分 100）· Weights</h2></div>
      <div class="card-c">
        <div class="weights-row" id="weightsGrid">
          <!-- 动态填充 -->
        </div>
        <div class="hint">输入时不再整卡重渲染。使用合成文本（IME）也不会打断。</div>
      </div>
    </div>

    <!-- 房源列表 -->
    <div id="rowsRoot"></div>
  </div>

<script>
/* ---------- 数据结构 ---------- */
const defaultWeights = {
  noise: 20,
  safety: 15,
  builtYear: 8,
  floorLevel: 8,
  flooring: 8,
  transit: 10,
  highwayDistance: 6,
  flightPath: 6,
  fees: 8,
  leaseTerms: 6,
  amenities: 5,
  reviews: 8
};

function emptyRow(){
  return {
    name: "",
    address: "",
    rent: 0,
    leaseMonths: 12,
    promoWeeks: 0,
    builtYear: 2015,
    floorLevel: 3,
    flooring: "wood",
    distanceToTransitKm: 1.0,
    distanceToHighwayKm: 1.0,
    nearArterial: false,
    underFlightPath: false,
    airportMinutes: 20,
    noiseUserScore: 5,   // 1 quiet — 10 noisy
    safetyScore: 7,      // 1 low   — 10 high
    parkingFee1: 0,
    parkingFee2: 0,
    trashFee: 0,
    packageLocker: true,
    gated: true,
    pestsSeen: false,
    subleaseAllowed: true,
    leaseBreakReasonable: true,
    parkingType: "uncovered",
    googleRating: 4.2,
    yelpRating: 4.0,
    note: ""
  };
}

/* ---------- 工具函数 ---------- */
const $ = (sel,root=document)=>root.querySelector(sel);
function clamp01(x){ return Math.max(0, Math.min(1, x)); }
function toNumber(n){ const v = Number(n); return Number.isFinite(v) ? v : 0; }

function calcEffectiveRent(row){
  const rent = toNumber(row.rent);
  const months = Math.max(1, toNumber(row.leaseMonths));
  const promoWeeks = Math.max(0, toNumber(row.promoWeeks));
  const promoDiscount = (rent * promoWeeks) / months / 4.33; // 约 4.33 周/月
  return Math.max(0, rent - promoDiscount);
}
function calcNetMonthly(row){
  const eff = calcEffectiveRent(row);
  const fees = Math.max(0, toNumber(row.trashFee) + toNumber(row.parkingFee1) + toNumber(row.parkingFee2));
  return Math.round(eff + fees);
}

function scoreRow(row, weights){
  const wSum = Object.values(weights).reduce((a,b)=>a+b,0);

  const userQuiet = 1 - clamp01((row.noiseUserScore - 1) / 9);
  let highwayAdj = 0;
  if (row.distanceToHighwayKm < 0.2) highwayAdj = -0.3;
  else if (row.distanceToHighwayKm < 0.5) highwayAdj = -0.2;
  else if (row.distanceToHighwayKm < 1) highwayAdj = -0.1;
  const flightAdj = row.underFlightPath ? -0.3 : 0;
  const arterialAdj = row.nearArterial ? -0.1 : 0;
  const noiseScore = clamp01(userQuiet + highwayAdj + flightAdj + arterialAdj);

  const safetyScore = clamp01((toNumber(row.safetyScore) - 1) / 9);
  const yearNorm = clamp01((toNumber(row.builtYear) - 2010) / (2025 - 2010));
  const floorNorm = row.floorLevel >= 3 ? 1 : clamp01(row.floorLevel / 3);
  const flooringMap = { wood: 1, mix: 0.6, carpet: 0.2 };
  const flooringScore = flooringMap[row.flooring] ?? 0.5;

  const d = toNumber(row.distanceToTransitKm);
  let transitScore = 0;
  if (d <= 0.5) transitScore = 1;
  else if (d <= 2) transitScore = 0.8;
  else if (d <= 3.5) transitScore = 0.5;
  else if (d <= 5) transitScore = 0.3;
  else transitScore = 0.1;

  const h = toNumber(row.distanceToHighwayKm);
  let highwayScore = 0.1;
  if (h >= 2) highwayScore = 1;
  else if (h >= 1) highwayScore = 0.7;
  else if (h >= 0.5) highwayScore = 0.5;
  else if (h >= 0.2) highwayScore = 0.3;
  else highwayScore = 0.1;

  const flightPathScore = row.underFlightPath ? 0.1 : 1;
  const fee = Math.max(0, toNumber(row.parkingFee1) + toNumber(row.parkingFee2) + toNumber(row.trashFee));
  const feesScore = clamp01(1 - fee / 400);
  const leaseTermsScore = (row.subleaseAllowed ? 0.5 : 0) + (row.leaseBreakReasonable ? 0.5 : 0);
  const amenitiesBase = (row.gated ? 0.35 : 0) + (row.packageLocker ? 0.35 : 0);
  const parkingBonus = row.parkingType === "garage" ? 0.3 : row.parkingType === "covered" ? 0.2 : 0.1;
  const amenitiesScore = clamp01(amenitiesBase + parkingBonus);
  const reviewsScore = clamp01(((toNumber(row.googleRating)/5) + (toNumber(row.yelpRating)/5)) / 2);

  const total = (
    noiseScore * weights.noise +
    safetyScore * weights.safety +
    yearNorm * weights.builtYear +
    floorNorm * weights.floorLevel +
    flooringScore * weights.flooring +
    transitScore * weights.transit +
    highwayScore * weights.highwayDistance +
    flightPathScore * weights.flightPath +
    feesScore * weights.fees +
    leaseTermsScore * weights.leaseTerms +
    amenitiesScore * weights.amenities +
    reviewsScore * weights.reviews
  ) / wSum;

  return {
    total: Math.round(total * 100),
    subs: {
      noise: Math.round(noiseScore * 100),
      safety: Math.round(safetyScore * 100),
      year: Math.round(yearNorm * 100),
      floor: Math.round(floorNorm * 100),
      flooring: Math.round(flooringScore * 100),
      transit: Math.round(transitScore * 100),
      highway: Math.round(highwayScore * 100),
      flight: Math.round(flightPathScore * 100),
      fees: Math.round(feesScore * 100),
      lease: Math.round(leaseTermsScore * 100),
      amenities: Math.round(amenitiesScore * 100),
      reviews: Math.round(reviewsScore * 100),
      effectiveRent: Math.round(calcEffectiveRent(row)),
      netMonthly: calcNetMonthly(row)
    }
  };
}

/* ---------- 状态 ---------- */
let weights = {...defaultWeights};
let rows = [emptyRow()];

/* ---------- 渲染骨架（一次性） ---------- */
const weightLabels = {
  noise:"Noise", safety:"Safety", builtYear:"Built Year", floorLevel:"Floor Level",
  flooring:"Flooring", transit:"Transit", highwayDistance:"Highway Dist.", flightPath:"Flight Path",
  fees:"Fees", leaseTerms:"Lease Terms", amenities:"Amenities", reviews:"Reviews"
};

function createWeightsUI(){
  const grid = document.getElementById("weightsGrid");
  Object.entries(weights).forEach(([key,val])=>{
    const wrap = document.createElement("div");
    wrap.className = "weights-item";
    wrap.innerHTML = `
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">
        <div><strong>${weightLabels[key] || key}</strong> <output>${val}</output></div>
        <button class="btn" data-weight="${key}" data-action="reset">重置</button>
      </div>
      <input type="range" min="0" max="30" step="1" value="${val}" data-weight="${key}" />
    `;
    grid.appendChild(wrap);
  });
  grid.addEventListener("input",(e)=>{
    const t=e.target;
    if(t.matches('input[type="range"][data-weight]')){
      const key=t.dataset.weight; weights[key]=Number(t.value);
      t.previousElementSibling.querySelector("output").textContent=t.value;
      // 批量刷新所有计算区（不改输入 DOM）
      rows.forEach((_,i)=>updateComputed(i));
    }
  });
  grid.addEventListener("click",(e)=>{
    const btn=e.target.closest("button[data-action='reset']");
    if(!btn) return;
    const key=btn.dataset.weight; weights[key]=defaultWeights[key];
    btn.parentElement.querySelector("output").textContent=weights[key];
    btn.parentElement.nextElementSibling.value=weights[key];
    rows.forEach((_,i)=>updateComputed(i));
  });
}

function createRowCard(idx){
  const row = rows[idx];
  const card = document.createElement("div");
  card.className = "card";
  card.dataset.idx = idx;

  card.innerHTML = `
    <div class="card-h">
      <h2>房源 <span data-ref="rowNo">${idx+1}</span></h2>
      <div class="row-topline">
        <div class="badge">总分：<span data-ref="total">0</span> / 100</div>
        <div class="pill"><span class="muted">Eff. Rent</span><strong>$<span data-ref="effRent">0</span></strong></div>
        <div class="pill"><span class="muted">Net Monthly</span><strong>$<span data-ref="netMonthly">0</span></strong></div>
        <button class="btn danger" data-remove>删除</button>
      </div>
    </div>
    <div class="card-c">
      <div class="grid g-3">
        ${inputRow("名称 / Name","text","name",row.name)}
        ${inputRow("地址 / Address","text","address",row.address)}
        ${inputRow("挂牌月租（USD）/ Asking Rent","number","rent",row.rent)}
        ${inputRow("租期（月）/ Lease Months","number","leaseMonths",row.leaseMonths)}
        ${inputRow("优惠免租（周）/ Promo Free Weeks","number","promoWeeks",row.promoWeeks,`<div class='hint'>有效月租：$<span data-ref='effRent2'>0</span>（已考虑免租周）</div>`)}
        <div>
          <label>净月支出（优惠后 + 2车位 + 垃圾费）</label>
          <input type="text" value="" data-ref="netMonthlyInput" readonly />
        </div>
      </div>

      <div class="hr"></div>

      <div class="grid g-5">
        ${inputRow("建造年份 / Built Year","number","builtYear",row.builtYear)}
        ${inputRow("楼层 / Floor Level","number","floorLevel",row.floorLevel)}
        ${selectRow("地板 / Flooring","flooring",row.flooring,[["wood","木地板"],["mix","混合"],["carpet","地毯"]])}
        ${selectRow("停车类型 / Parking","parkingType",row.parkingType,[["uncovered","露天"],["covered","有顶棚"],["garage","车库"]])}
        ${checkboxRow("是否有虫害问题 / Pests Seen","pestsSeen",row.pestsSeen)}
      </div>

      <div class="hr"></div>

      <div class="grid g-5">
        ${inputRow("距轻轨/地铁（km）","number","distanceToTransitKm",row.distanceToTransitKm,{step:"0.1"})}
        ${inputRow("距高速（km）","number","distanceToHighwayKm",row.distanceToHighwayKm,{step:"0.1"})}
        ${checkboxRow("附近是否主干道","nearArterial",row.nearArterial)}
        ${checkboxRow("是否在飞机航线下","underFlightPath",row.underFlightPath)}
        ${inputRow("到机场车程（分钟）","number","airportMinutes",row.airportMinutes)}
        ${inputRow("你主观的噪音评分（1=安静, 10=很吵）","number","noiseUserScore",row.noiseUserScore,{min:"1",max:"10"})}
        ${inputRow("社区安全评分（1=差, 10=好）","number","safetyScore",row.safetyScore,{min:"1",max:"10"})}
        ${inputRow("停车费-第一辆（$/月）","number","parkingFee1",row.parkingFee1)}
        ${inputRow("停车费-第二辆（$/月）","number","parkingFee2",row.parkingFee2)}
        ${inputRow("垃圾/下水道费（$/月）","number","trashFee",row.trashFee)}
        ${checkboxRow("门禁（Gated）","gated",row.gated)}
        ${checkboxRow("快递柜（Package Locker）","packageLocker",row.packageLocker)}
        ${checkboxRow("允许转租（Sublease）","subleaseAllowed",row.subleaseAllowed)}
        ${checkboxRow("提前解约条款合理","leaseBreakReasonable",row.leaseBreakReasonable)}
      </div>

      <div class="hr"></div>

      <div class="grid g-4">
        ${inputRow("Google 评分（0–5）","number","googleRating",row.googleRating,{step:"0.1",min:"0",max:"5"})}
        ${inputRow("Yelp 评分（0–5）","number","yelpRating",row.yelpRating,{step:"0.1",min:"0",max:"5"})}
        <div class="hint" style="grid-column: span 2;">提示：此分需要手动输入（建议核对近一年评论）。</div>
      </div>

      <div class="hr"></div>

      <div>
        <label>备注 / 亮点笔记</label>
        <textarea data-key="note" data-ime></textarea>
      </div>

      <div class="hr"></div>

      <div class="subscores">
        ${subPill("Noise")}${subPill("Safety")}${subPill("Year")}${subPill("Floor")}${subPill("Flooring")}${subPill("Transit")}
        ${subPill("Highway")}${subPill("FlightPath")}${subPill("Fees")}${subPill("Lease")}${subPill("Amenities")}${subPill("Reviews")}
        ${subPill("Eff. Rent")}${subPill("Net Monthly")}
      </div>
    </div>
  `;
  // 填充备注初值
  card.querySelector('textarea[data-key="note"]').value = row.note || "";
  // 绑定事件（增量更新）
  bindRowEvents(card, idx);
  // 初次计算
  updateComputed(idx, card);
  return card;
}

function inputRow(label,type,key,val,attrs={}){
  const extra = Object.entries(attrs).map(([k,v])=>`${k}="${v}"`).join(" ");
  return `
    <div>
      <label>${label}</label>
      <input type="${type}" data-key="${key}" value="${val}" ${extra} ${type!=="number"?'data-ime':''} />
    </div>
  `;
}
function selectRow(label,key,val,options){
  return `
    <div>
      <label>${label}</label>
      <select data-key="${key}">
        ${options.map(([v,t])=>`<option value="${v}" ${v===val?'selected':''}>${t}</option>`).join("")}
      </select>
    </div>
  `;
}
function checkboxRow(label,key,checked){
  return `
    <div>
      <label>${label}</label>
      <div class="switch">
        <input type="checkbox" data-key="${key}" ${checked?'checked':''} />
        <span class="muted">${checked?'是':'否'}</span>
      </div>
    </div>
  `;
}
function subPill(name){
  return `<div class="pill"><span class="muted">${name}</span><strong data-sub="${name}">-</strong></div>`;
}

/* ---------- 绑定与增量更新 ---------- */
function bindRowEvents(card, idx){
  // 删除
  card.querySelector("[data-remove]").addEventListener("click",()=>{
    rows.splice(idx,1);
    rebuildAll();
  });

  // 输入事件：中文 IME 友好
  let composing = false;
  card.addEventListener("compositionstart",(e)=>{
    if(e.target.matches("[data-ime]")) composing = true;
  });
  card.addEventListener("compositionend",(e)=>{
    if(e.target.matches("[data-ime]")) {
      composing = false;
      handleInput(e, idx, card);
    }
  });
  card.addEventListener("input",(e)=>{
    if(composing && e.target.matches("[data-ime]")) return; // 组合输入中，不打断
    handleInput(e, idx, card);
  });
}

function handleInput(e, idx, card){
  const t = e.target;
  const key = t.dataset.key;
  if(!key) return;
  const row = rows[idx];
  if(t.type === "checkbox"){
    row[key] = t.checked;
    // 同步“是/否”标签
    const label = t.closest(".switch")?.querySelector(".muted");
    if(label) label.textContent = t.checked ? "是" : "否";
  }else if(t.tagName === "SELECT"){
    row[key] = t.value;
  }else if(t.type === "number"){
    row[key] = Number(t.value);
  }else{
    row[key] = t.value;
  }
  // 仅更新计算区与少量显示，不重建 DOM
  queueUpdate(idx, card);
}

function updateComputed(idx, card){
  const s = scoreRow(rows[idx], weights);
  const $r = (sel)=>card ? card.querySelector(sel) : document.querySelector(`.card[data-idx="${idx}"] ${sel}`);
  $r('[data-ref="total"]').textContent = s.total;
  $r('[data-ref="effRent"]').textContent = s.subs.effectiveRent;
  $r('[data-ref="effRent2"]').textContent = s.subs.effectiveRent;
  $r('[data-ref="netMonthly"]').textContent = s.subs.netMonthly;
  $r('[data-ref="netMonthlyInput"]').value = "$" + s.subs.netMonthly;
  // 子分
  const subs = s.subs;
  const map = {
    "Noise":"noise","Safety":"safety","Year":"year","Floor":"floor","Flooring":"flooring",
    "Transit":"transit","Highway":"highway","FlightPath":"flight","Fees":"fees",
    "Lease":"lease","Amenities":"amenities","Reviews":"reviews","Eff. Rent":"effectiveRent","Net Monthly":"netMonthly"
  };
  Object.entries(map).forEach(([label, key])=>{
    const el = $r(`[data-sub="${label}"]`);
    if(el) el.textContent = subs[key];
  });
}

/* --- RAF 批量更新，避免频繁重排 --- */
let rafId = null;
const pending = new Set();
function queueUpdate(idx, card){
  pending.add(idx + ":" + (card ? "1" : "0"));
  if(rafId) return;
  rafId = requestAnimationFrame(()=>{
    pending.forEach(key=>{
      const [i] = key.split(":");
      const cardEl = document.querySelector(`.card[data-idx="${i}"]`);
      updateComputed(Number(i), cardEl);
    });
    pending.clear();
    rafId = null;
  });
}

/* ---------- 构建 / 重建 ---------- */
function rebuildAll(){
  const root = document.getElementById("rowsRoot");
  root.innerHTML = "";
  rows.forEach((_,i)=> root.appendChild(createRowCard(i)));
}

function init(){
  createWeightsUI();
  rebuildAll();

  document.getElementById("addRowBtn").addEventListener("click",()=>{
    rows.push(emptyRow());
    rebuildAll();
    window.scrollTo({top:document.body.scrollHeight,behavior:"smooth"});
  });

  document.getElementById("downloadCsvBtn").addEventListener("click", ()=>{
    const header = [
      "Name","Address","Rent","LeaseMonths","PromoWeeks","EffectiveRent","NetMonthly","Score",
      "BuiltYear","Floor","Flooring","TransitKm","HighwayKm","NearArterial","UnderFlightPath","AirportMin",
      "Noise(1-10)","Safety(1-10)","ParkingFee1","ParkingFee2","TrashFee","Gated","Locker","PestsSeen","Sublease","LeaseBreakReasonable","ParkingType",
      "GoogleRating","YelpRating","Note"
    ];
    const lines = rows.map((row,i)=>{
      const s = scoreRow(row,weights);
      return [
        row.name,row.address,row.rent,row.leaseMonths,row.promoWeeks,s.subs.effectiveRent,s.subs.netMonthly,s.total,
        row.builtYear,row.floorLevel,row.flooring,row.distanceToTransitKm,row.distanceToHighwayKm,row.nearArterial,row.underFlightPath,row.airportMinutes,
        row.noiseUserScore,row.safetyScore,row.parkingFee1,row.parkingFee2,row.trashFee,row.gated,row.packageLocker,row.pestsSeen,row.subleaseAllowed,row.leaseBreakReasonable,row.parkingType,
        row.googleRating,row.yelpRating,JSON.stringify(row.note).replace(/\n/g,"\\n")
      ].join(",");
    });
    const csv = [header.join(","),...lines].join("\n");
    const blob = new Blob([csv],{type:"text/csv;charset=utf-8;"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = "apartment_scoring_v3.csv"; a.click();
    URL.revokeObjectURL(url);
  });
}

document.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>"""
path = "/mnt/data/看房评分表（可交互网页ui）-v3-fast.html"
with open(path, "w", encoding="utf-8") as f:
    f.write(html)
path
